<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content {
  display: none;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-slide {
  animation: slideDown 0.6s ease-out forwards;
}

.post-content,
.post-content * {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}
</style>

<div id="page-404">
  <h1>404</h1>
  <p>Halaman tidak ditemukan.</p>
  <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
  <div class="list-title"><h1>Blog:</h1></div>

  {% for post in site.posts %}
  <article
    class="post"
    data-type="post"
    data-url="{{ post.url | relative_url }}"
  >
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
  {% endfor %}
</div>

<div
  id="spa-debug"
  style="
    position: fixed;
    left: 10px;
    right: 10px;
    bottom: 10px;
    max-height: 120px;
    overflow: auto;
    padding: 8px;
    font: 12px monospace;
    background: #001a4d;
    color: #9eff9e;
    z-index: 999;
    border-radius: 4px;
  "
></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const listTitle = document.querySelector('.list-title');
  const debugBox  = document.getElementById('spa-debug');

  const BLOG_PATH = '/blog/';
  let STATE = '';

  /* ---------------- utils ---------------- */

  const safe = (el, fn) => el && fn(el);

  const normalize = p =>
    p.replace(/\/$/, '').replace(/\.html$/, '');

  function getPosts() {
    return [...document.querySelectorAll('.post[data-type="post"]')];
  }

  function hideAll() {
    [homepage, postsWrap, page404].forEach(el =>
      safe(el, e => {
        e.style.display = 'none';
        e.classList.remove('animate-slide');
        void e.offsetWidth;
      })
    );

    getPosts().forEach(p => {
      p.style.display = 'none';
      p.classList.remove('animate-slide');

      const c = p.querySelector('.post-content');
      const a = p.querySelector('.post-title a');
      if (c) c.style.display = 'none';
      if (a) a.style.display = '';
    });
  }

  function push(path) {
    if (location.pathname !== path) {
      history.pushState(null, '', path);
    }
  }

  /* ---------------- renderers ---------------- */

  function renderHome(pushState) {
    STATE = 'home';
    hideAll();

    safe(homepage, el => {
      el.style.display = 'block';
      el.classList.add('animate-slide');
    });

    if (pushState) push('/');
    debug();
  }

  function renderList(pushState) {
    STATE = 'list';
    hideAll();

    safe(listTitle, el => el.style.display = 'block');

    safe(postsWrap, el => {
      el.style.display = 'block';
      el.classList.add('animate-slide');
    });

    getPosts().forEach(p => {
      p.style.display = 'block';
      const ex = p.querySelector('.post-excerpt');
      if (ex) ex.style.display = 'block';
    });

    if (pushState) push(BLOG_PATH);
    debug();
  }

  function renderPost(post, pushState) {
    STATE = 'post';
    hideAll();

    safe(listTitle, el => el.style.display = 'none');

    safe(postsWrap, el => {
      el.style.display = 'block';
      el.classList.add('animate-slide');
    });

    post.style.display = 'block';
    post.classList.add('animate-slide');

    const ex = post.querySelector('.post-excerpt');
    const c  = post.querySelector('.post-content');
    const a  = post.querySelector('.post-title a');

    if (ex) ex.style.display = 'none';
    if (c)  c.style.display  = 'block';
    if (a)  a.style.display  = 'none';

    if (pushState) push(post.dataset.url);
    debug();
  }

  function render404(path, pushState) {
    STATE = '404';
    hideAll();

    safe(page404, el => el.style.display = 'block');
    if (pushState) push(path);
    debug();
  }

  /* ---------------- routing ---------------- */

  function findPostByPath(path) {
    const cleanPath = normalize(path);
    let found = null;

    getPosts().forEach(p => {
      const postUrl = normalize(p.dataset.url);
      const match = cleanPath === postUrl;

      safe(debugBox, box => {
        box.innerHTML += `[CHECK] ${cleanPath} === ${postUrl} â†’ ${match}<br>`;
      });

      if (match) found = p;
    });

    return found;
  }

  function router(path = location.pathname, pushState = false) {
    safe(debugBox, box => {
      box.innerHTML = `<b>[ROUTING]</b> ${path}<br>`;
    });

    const cleanPath     = normalize(path);
    const cleanBlogPath = normalize(BLOG_PATH);

    if (cleanPath === '' || cleanPath === '/' || cleanPath === '/index') {
      return renderHome(pushState);
    }

    if (cleanPath === cleanBlogPath) {
      return renderList(pushState);
    }

    const post = findPostByPath(path);
    if (post) {
      return renderPost(post, pushState);
    }

    render404(path, pushState);
  }

  /* ---------------- link interception ---------------- */

  document.addEventListener('click', e => {
    const a = e.target.closest('a[href]');
    if (!a) return;

    const url = new URL(a.href, location.origin);
    if (url.origin !== location.origin) return;

    e.preventDefault();
    router(url.pathname, true);
  });

  window.addEventListener('popstate', () => {
    router(location.pathname, false);
  });

  /* ---------------- debug ---------------- */

  function debug() {
    safe(debugBox, box => {
      box.innerHTML +=
        `<hr><b>STATE:</b> ${STATE}<br>` +
        `<b>PATH:</b> ${location.pathname}<br>`;
    });
  }

  /* ---------------- init ---------------- */

  router(location.pathname, false);
});
</script>
