<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content { display: none; }

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px); /* Mulai dari sedikit di atas */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Berakhir di posisi asli */
  }
}

/* Class untuk memicu animasi */
.animate-slide {
  animation: slideDown 2s ease-out forwards;
}

.post-content,
.post-content * {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}
</style>

<div id="page-404" style="display:none;">
    <h1>404</h1>
    <p>Halaman tidak ditemukan.</p>
    <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
<div class="list-title"><h1>Blog:</h1></div>
{% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
{% endfor %}
</div>

<div id="spa-debug" style="
  display: visible;
  position: fixed;
  max-height: 100px;
  overflow: auto;
  left: 10px;
  bottom: 10px;
  right: 10px;
  padding: 8px 10px;
  font: 12px monospace;
  background: darkblue;
  color: lightgreen;
  z-index: 9;
  border-radius: 4px;
"></div>

<script>  
document.addEventListener('DOMContentLoaded', () => {
  // 1. Selektor Elemen
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog'); // Tombol di Home
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  
  const BLOG_PATH = '/blog/'; // Pastikan ini sesuai dengan URL daftar blog Anda
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];  

  /* ---------------- Core Functions ---------------- */

  function hideAll() {  
    // Sembunyikan semua kontainer utama
    [spaHome, homepage, postsWrap, page404].forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
      void e.offsetWidth; 
    }));

    // Reset semua artikel
    getPosts().forEach(p => {  
      p.style.display = 'none';
      const c = p.querySelector('.post-content');  
      const a = p.querySelector('.post-title a');  
      const ex = p.querySelector('.post-excerpt');
      if (c) c.style.display = 'none'; 
      if (a) a.style.display = ''; 
      if (ex) ex.style.display = 'block';
    });  
  }

  function push(path) {  
    if (location.pathname !== path) {  
      history.pushState(null, '', path);  
    }  
  }  
  
  /* ---------------- Renderers ---------------- */  
  
  function renderHome(pushState) {  
    STATE = 'home';  
    hideAll(); 
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block';
      e.classList.add('animate-slide');
    })); 
    if (pushState) push('/');  
    debug();  
  }

  function renderList(pushState) {  
    STATE = 'list';  
    hideAll(); 
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });  
    getPosts().forEach(p => {
        p.style.display = 'block';
    });
    if (pushState) push(BLOG_PATH);  
    debug();  
  }

  function renderPost(post, pushState) {  
    STATE = 'post';  
    hideAll();
    safe(listTitle, el => el.style.display = 'none');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });
    
    post.style.display = 'block';
    const c = post.querySelector('.post-content');  
    const a = post.querySelector('.post-title a');  
    const ex = post.querySelector('.post-excerpt');

    if (c) c.style.display = 'block';  
    if (a) a.style.display = 'none';  
    if (ex) ex.style.display = 'none'; // Sembunyikan ringkasan saat baca penuh
  
    if (pushState) push(post.dataset.url);  
    debug();  
  }

  /* ---------------- Helper: Path Finder ---------------- */

  function findPostByPath(path) {  
    const posts = getPosts();
    // Normalisasi path yang dicari
    const target = path.replace(/\/$/, "").replace(".html", "");
    
    // Jangan deteksi jika ini adalah path blog list
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace(".html", "");
    if (target === cleanBlogPath || target === "") return null;

    return posts.find(p => {
      const postUrl = p.dataset.url;
      if (!postUrl) return false;
      const cleanPostUrl = postUrl.replace(/\/$/, "").replace(".html", "");
      // Gunakan perbandingan yang lebih ketat
      return cleanPostUrl.endsWith(target) || target.endsWith(cleanPostUrl);
    });
  }

  /* ---------------- Router ---------------- */  

  function router(path = location.pathname, pushState = false) {  
    const cleanPath = path.replace(/\/$/, "").replace("/index.html", "") || "/";
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace("/index.html", "");

    safe(debugBox, box => box.innerHTML = `<b>[ROUTING]</b> Path: ${cleanPath}<br>`);

    // 1. CEK HOME
    if (cleanPath === '/' || cleanPath === '/index.html') {
      return renderHome(pushState);
    }

    // 2. CEK LIST BLOG (Exact Match)
    // Sekarang dicek SEBELUM post agar URL /blog/ tidak dianggap postingan
    if (cleanPath === cleanBlogPath || cleanPath === (cleanBlogPath + ".html")) {
      return renderList(pushState);
    }

    // 3. CEK POSTINGAN
    const post = findPostByPath(cleanPath);  
    if (post) {
      return renderPost(post, pushState);
    }

    // 4. FALLBACK 404
    render404(path, pushState);  
  }

  /* ---------------- Link & Button Listeners ---------------- */

  // Menangani semua klik link secara global
  document.addEventListener('click', e => {
    const a = e.target.closest('a');
    if (!a) return;
    
    const href = a.getAttribute('href');
    if (!href || href.startsWith('#')) return;

    // Pastikan link internal
    try {
      const url = new URL(href, location.origin);
      if (url.origin === location.origin) {
        e.preventDefault();
        router(url.pathname, true);
      }
    } catch (err) {
      // Biarkan link eksternal atau invalid bekerja normal
    }
  });

  // Listener khusus tombol "Open Blog" (Jika tombolnya bukan tag <a>)
  if (btnBlog) {
    btnBlog.addEventListener('click', (e) => {
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', () => {  
    router(location.pathname, false);  
  });  

  function debug() {  
    if (!debugBox) return;  
    debugBox.innerHTML += `<hr><b>STATE:</b> ${STATE}<br><b>PATH:</b> ${location.pathname}`;  
  }  

  // Jalankan Router pertama kali
  router(location.pathname, false);
});  
</script>
