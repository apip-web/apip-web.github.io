<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content { display: none; }

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px); /* Mulai dari sedikit di atas */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Berakhir di posisi asli */
  }
}

/* Class untuk memicu animasi */
.animate-slide {
  animation: slideDown 2s ease-out forwards;
}

.post-content p {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}

#spa-button {

}

#spa-debug {
  display: none;
  position: fixed;
  bottom: 15px;
  left: 15px;
  right: 15px;
  max-height: 150px;
  overflow-y: auto;
  background: rgba(15, 23, 42, 0.6); /* Dark slate with transparency */
  backdrop-filter: blur(8px); /* Efek blur kaca */
  color: #e2e8f0;
  font-family: 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  z-index: 9999;
  scrollbar-width: thin;
}

#spa-debug code {
  font-size: 11px;
}

/* Log Label Styles */
.log-entry { margin-bottom: 4px; line-height: 1.4; }
.badge {
  padding: 2px 5px;
  border-radius: 3px;
  font-weight: bold;
  text-transform: uppercase;
  margin-right: 5px;
}
.badge-route { background: #3b82f6; color: white; }
.badge-state { background: #8b5cf6; color: white; }
.badge-success { background: #10b981; color: white; }
.badge-error { background: #ef4444; color: white; }
</style>

<div id="page-404" style="display:none;">
    <h1>404</h1>
    <p>Halaman tidak ditemukan.</p>
    <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
<div class="list-title"><h1>Blog:</h1></div>
{% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
{% endfor %}
</div>

<div id="spa-debug"></div>

<script>  
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  
  const BLOG_PATH = '/blog/';
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];  

  /* ---------------- Core Functions ---------------- */

  function hideAll() {  
    const containers = [spaHome, homepage, postsWrap, page404];
    containers.forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
      void e.offsetWidth; 
    }));

    getPosts().forEach(p => {  
      p.style.display = 'none';
      const c = p.querySelector('.post-content');  
      const a = p.querySelector('.post-title a');  
      const ex = p.querySelector('.post-excerpt');
      if (c) c.style.display = 'none'; 
      if (a) a.style.display = ''; 
      if (ex) ex.style.display = 'block';
    });  
  }

  function push(path) {  
    if (location.pathname !== path) {  
      history.pushState(null, '', path);  
    }  
  }  
  
  /* ---------------- Renderers ---------------- */  
  
  function renderHome(pushState) {  
    STATE = 'home';  
    hideAll(); 
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block';
      e.classList.add('animate-slide');
    })); 
    if (pushState) push('/');  
    debug();  
  }

  function renderList(pushState) {  
    STATE = 'list';  
    hideAll(); 
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });  
    getPosts().forEach(p => p.style.display = 'block');
    if (pushState) push(BLOG_PATH);  
    debug();  
  }

  function renderPost(post, pushState) {  
    STATE = 'post';  
    hideAll();
    safe(listTitle, el => el.style.display = 'none');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });
    
    post.style.display = 'block';
    const c = post.querySelector('.post-content');  
    const a = post.querySelector('.post-title a');  
    const ex = post.querySelector('.post-excerpt');

    if (c) c.style.display = 'block';  
    if (a) a.style.display = 'none';  
    if (ex) ex.style.display = 'none';
  
    if (pushState) push(post.dataset.url);  
    debug();  
  }

  function render404(path, pushState) {  
    STATE = '404';  
    hideAll();  
    safe(page404, el => el.style.display = 'block');  
    if (pushState) push(path);  
    debug();  
  }

/* --- Finder yang lebih sederhana dan aman --- */
function findPostByPath(path) {
  const posts = getPosts();
  // Bandingkan path apa adanya dari browser dengan data-url di HTML
  return posts.find(p => p.dataset.url === path);
}

/* --- Router yang lebih stabil --- */
function router(path = location.pathname, pushState = false) {
  // Hanya hapus trailing slash paling belakang agar /blog/ dan /blog terbaca sama
  const cleanPath = path.length > 1 ? path.replace(/\/$/, "") : path;
  const cleanBlogPath = BLOG_PATH.replace(/\/$/, "");

  safe(debugBox, box => {
  box.innerHTML = `<div class="log-entry">
    <span class="badge badge-route">Routing</span> 
    Path: <code style="color: #60a5fa">${cleanPath}</code>
  </div>`;
});

  // 1. Cek Home
  if (cleanPath === '/' || cleanPath === '/index.html') {
    return renderHome(pushState);
  }

  // 2. Cek List Blog (Gunakan perbandingan kaku, BUKAN .includes)
  if (cleanPath === cleanBlogPath || cleanPath === BLOG_PATH) {
    return renderList(pushState);
  }

  // 3. Cek Postingan (Cari yang datanya sama persis)
  const post = findPostByPath(path); // Gunakan path asli (misal: /blog/post.html)
  if (post) {
    return renderPost(post, pushState);
  }

  // 4. Fallback 404
  render404(path, pushState);
}

  /* ---------------- Event Listeners ---------------- */

/* ---------------- Event Listeners ---------------- */

document.addEventListener('click', e => {
  const a = e.target.closest('a');
  if (!a) return;
  
  const href = a.getAttribute('href');
  if (!href || href.startsWith('#')) return;

  try {
    const url = new URL(href, location.origin);
    
    // PERBAIKAN: Jika link mengandung Hash, jangan e.preventDefault() secara kaku
    // Biarkan browser menangani perubahan hash setelah navigasi ke /tags/
    if (url.origin === location.origin) {
      if (url.hash && url.pathname === '/tags/') {
        // Biarkan link menuju halaman tags dengan hash tetap bekerja normal
        // agar script di halaman tags bisa membaca hash-nya.
        return; 
      }
      
      e.preventDefault();
      router(url.pathname, true);
    }
  } catch (err) {}
});

  if (btnBlog) {
    btnBlog.addEventListener('click', (e) => {
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', () => {  
    router(location.pathname, false);  
  });  

/* ---------------- Debug Overlay Logic ---------------- */

  function debug() {  
    if (!debugBox) return;  
    
    let stateClass = (STATE === '404') ? 'badge-error' : 'badge-state';
    
    debugBox.innerHTML += `
      <div class="log-entry" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px;">
        <span class="badge ${stateClass}">State</span> ${STATE}
      </div>
      <div class="log-entry">
        <span class="badge badge-success">URL</span> ${location.pathname}
      </div>`;
    
    debugBox.scrollTop = debugBox.scrollHeight;
  }

  // FITUR COPY: Menggunakan penanganan error agar lebih stabil
  if (debugBox) {  
    debugBox.addEventListener('click', function() {  
      // Ambil teks bersih (tanpa tag HTML) agar hasil paste rapi
      const contentToCopy = debugBox.innerText; 
      
      navigator.clipboard.writeText(contentToCopy).then(() => {  
        const msg = document.createElement('div');
        msg.style.color = '#10b981';
        msg.style.fontSize = '10px';
        msg.style.marginTop = '5px';
        msg.innerHTML = `<i>âœ“ Copied to clipboard!</i>`;
        debugBox.appendChild(msg);
        debugBox.scrollTop = debugBox.scrollHeight;
        
        // Hapus pesan notifikasi setelah 2 detik
        setTimeout(() => msg.remove(), 2000);
      }).catch(err => {
        console.error('Gagal menyalin: ', err);
      });  
    });  
  }

  // INISIALISASI: Jalankan router pertama kali saat halaman dimuat
  router(location.pathname, false);

}); // Tutup DOMContentLoaded
</script>
