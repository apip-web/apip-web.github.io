<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content,
#tag-title,
#show-all { display: none; }

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-slide { animation: slideDown 2s ease-out forwards; }

.post-content p { white-space: normal; word-break: break-word; overflow-wrap: anywhere; }

#spa-debug {
  display: none;
  position: fixed;
  bottom: 15px;
  left: 15px;
  right: 15px;
  max-height: 150px;
  overflow-y: auto;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(8px);
  color: #e2e8f0;
  font-family: 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  z-index: 9999;
  scrollbar-width: thin;
}

#spa-debug code { font-size: 11px; }

.log-entry { margin-bottom: 4px; line-height: 1.4; }
.badge { padding: 2px 5px; border-radius: 3px; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
.badge-route { background: #3b82f6; color: white; }
.badge-state { background: #8b5cf6; color: white; }
.badge-success { background: #10b981; color: white; }
.badge-error { background: #ef4444; color: white; }

.post-tags { margin-top: 5px; }
.post-tags .tag { cursor: pointer; margin-right: 4px; padding: 2px 5px; border-radius: 3px; background: #ddd; border: none; }
</style>

<div id="spa-home" class="homepage">
  <h1>Welcome to Home</h1>
  <a href="/blog/" id="open-blog">Open Blog</a>
</div>

<div id="page-404">
  <h1>404</h1>
  <p>Halaman tidak ditemukan.</p>
  <a href="/">Kembali ke Home</a>
</div>

<h1 id="tag-title">All Posts</h1>
<button id="show-all">All</button>

<div id="posts">
  <div class="list-title"><h1>Blog:</h1></div>
  {% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}" data-tags="{{ post.tags | join: ',' }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-tags">
      {% for tag in post.tags %}
      <button class="tag" data-tag="{{ tag }}">#{{ tag }}</button>
      {% endfor %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
  {% endfor %}
</div>

<div id="spa-debug"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  const tagTitle  = document.getElementById('tag-title');
  const showAllBtn = document.getElementById('show-all');

  const BLOG_PATH = '/blog/';
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];

  /* ---------------- Core Functions ---------------- */
  function hideAll() {
    const containers = [spaHome, homepage, postsWrap, page404];
    containers.forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
      void e.offsetWidth;
    }));

    safe(tagTitle, el => el.style.display = 'none');
    safe(showAllBtn, el => el.style.display = 'none');

    getPosts().forEach(p => {
      p.style.display = 'none';
      const c = p.querySelector('.post-content');
      const a = p.querySelector('.post-title a');
      const ex = p.querySelector('.post-excerpt');
      if (c) c.style.display = 'none';
      if (a) a.style.display = '';
      if (ex) ex.style.display = 'block';
    });
  }

  function push(path) {
    if (location.pathname !== path) {
      history.pushState(null, '', path);
    }
  }

  /* ---------------- Renderers ---------------- */
  function renderHome(pushState) {
    STATE = 'home';
    hideAll();
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block';
      e.classList.add('animate-slide');
    }));
    if (pushState) push('/');
    debug();
  }

  function renderList(pushState, filterTag=null) {
    STATE = 'list';
    hideAll();
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => { el.style.display = 'block'; el.classList.add('animate-slide'); });
    safe(tagTitle, el => el.style.display = 'block');
    safe(showAllBtn, el => el.style.display = 'inline-block');

    getPosts().forEach(p => {
      if(filterTag){
        const tags = p.dataset.tags.split(',');
        p.style.display = tags.includes(filterTag) ? '' : 'none';
      } else {
        p.style.display = 'block';
      }
    });

    if(filterTag){
      tagTitle.textContent = `Showing posts under "${filterTag}"`;
      location.hash = filterTag;
    } else {
      tagTitle.textContent = 'All Posts';
      location.hash = '';
    }

    if (pushState) push(BLOG_PATH);
    debug();
  }

  function renderPost(post, pushState) {
    STATE = 'post';
    hideAll();
    safe(postsWrap, el => { el.style.display = 'block'; el.classList.add('animate-slide'); });

    post.style.display = 'block';
    const c = post.querySelector('.post-content');
    const a = post.querySelector('.post-title a');
    const ex = post.querySelector('.post-excerpt');
    if (c) c.style.display = 'block';
    if (a) a.style.display = 'none';
    if (ex) ex.style.display = 'none';

    if (pushState) push(post.dataset.url);
    debug();
  }

  function render404(path, pushState) {
    STATE = '404';
    hideAll();
    safe(page404, el => el.style.display = 'block');
    if (pushState) push(path);
    debug();
  }

  /* ---------------- Router ---------------- */
  function findPostByPath(path) {
    const posts = getPosts();
    const target = path.replace(/\/$/, "").replace(".html", "");
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace(".html", "");
    if (target === cleanBlogPath || target === "") return null;
    return posts.find(p => {
      const postUrl = p.dataset.url;
      if(!postUrl) return false;
      const cleanPostUrl = postUrl.replace(/\/$/, "").replace(".html", "");
      return cleanPostUrl.endsWith(target) || target.endsWith(cleanPostUrl);
    });
  }

  function router(path = location.pathname, pushState = false) {
    const cleanPath = path.replace(/\/$/, "").replace("/index.html", "") || "/";
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace("/index.html", "");

    safe(debugBox, box => {
      box.innerHTML = `<div class="log-entry">
        <span class="badge badge-route">Routing</span>
        Path: <code style="color: #60a5fa">${cleanPath}</code>
      </div>`;
    });

    if(cleanPath === '/' || cleanPath === '/index.html') return renderHome(pushState);

    if(cleanPath === cleanBlogPath || cleanPath === (cleanBlogPath + ".html") || path.includes('blog.html')){
      if(cleanPath !== cleanBlogPath && findPostByPath(cleanPath)){
        // lanjut ke post
      } else {
        // cek query string tag
        const params = new URLSearchParams(location.search);
        const tag = params.get('tag');
        return renderList(pushState, tag);
      }
    }

    const post = findPostByPath(cleanPath);
    if(post) return renderPost(post, pushState);

    render404(path, pushState);
  }

  /* ---------------- Event Listeners ---------------- */
  document.addEventListener('click', e => {
    const a = e.target.closest('a');
    if(!a) return;
    const href = a.getAttribute('href');
    if(!href || href.startsWith('#')) return;

    try {
      const url = new URL(href, location.origin);
      if(url.origin === location.origin){
        e.preventDefault();
        router(url.pathname, true);
      }
    } catch(err){}
  });

  if(btnBlog){
    btnBlog.addEventListener('click', e=>{
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', ()=>{ router(location.pathname, false); });

  /* ---------------- Tag Filter ---------------- */
  function filterByTag(tag){
    renderList(false, tag);
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.tag');
    if(!btn) return;
    e.preventDefault();
    const tag = btn.dataset.tag;
    filterByTag(tag);
  });

  if(showAllBtn){
    showAllBtn.addEventListener('click', ()=>{
      renderList(true, null);
    });
  }

  /* ---------------- Debug ---------------- */
  function debug(){
    if(!debugBox) return;
    let stateClass = (STATE==='404')?'badge-error':'badge-state';
    debugBox.innerHTML += `<div class="log-entry" style="border-top:1px solid rgba(255,255,255,0.1);margin-top:8px;padding-top:8px;">
      <span class="badge ${stateClass}">State</span> ${STATE}
    </div>
    <div class="log-entry"><span class="badge badge-success">URL</span> ${location.pathname}</div>`;
    debugBox.scrollTop = debugBox.scrollHeight;
  }

  router(location.pathname,false);
});
</script>
