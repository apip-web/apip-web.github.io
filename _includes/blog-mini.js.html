<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content { display: none; }

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px); /* Mulai dari sedikit di atas */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Berakhir di posisi asli */
  }
}

/* Class untuk memicu animasi */
.animate-slide {
  animation: slideDown 2s ease-out forwards;
}

.post-content,
.post-content * {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}
</style>

<div id="page-404" style="display:none;">
    <h1>404</h1>
    <p>Halaman tidak ditemukan.</p>
    <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
<div class="list-title"><h1>Blog:</h1></div>
{% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
{% endfor %}
</div>

<div id="spa-debug" style="
  display: visible;
  position: fixed;
  max-height: 100px;
  overflow: auto;
  left: 10px;
  bottom: 10px;
  right: 10px;
  padding: 8px 10px;
  font: 12px monospace;
  background: darkblue;
  color: lightgreen;
  z-index: 9;
  border-radius: 4px;
"></div>

<script>  
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  
  const BLOG_PATH = '/blog/';
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];  

  /* ---------------- Core Functions ---------------- */

  function hideAll() {  
    const containers = [spaHome, homepage, postsWrap, page404];
    containers.forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
      void e.offsetWidth; 
    }));

    getPosts().forEach(p => {  
      p.style.display = 'none';
      const c = p.querySelector('.post-content');  
      const a = p.querySelector('.post-title a');  
      const ex = p.querySelector('.post-excerpt');
      if (c) c.style.display = 'none'; 
      if (a) a.style.display = ''; 
      if (ex) ex.style.display = 'block';
    });  
  }

  function push(path) {  
    if (location.pathname !== path) {  
      history.pushState(null, '', path);  
    }  
  }  
  
  /* ---------------- Renderers ---------------- */  
  
  function renderHome(pushState) {  
    STATE = 'home';  
    hideAll(); 
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block';
      e.classList.add('animate-slide');
    })); 
    if (pushState) push('/');  
    debug();  
  }

  function renderList(pushState) {  
    STATE = 'list';  
    hideAll(); 
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });  
    getPosts().forEach(p => p.style.display = 'block');
    if (pushState) push(BLOG_PATH);  
    debug();  
  }

  function renderPost(post, pushState) {  
    STATE = 'post';  
    hideAll();
    safe(listTitle, el => el.style.display = 'none');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });
    
    post.style.display = 'block';
    const c = post.querySelector('.post-content');  
    const a = post.querySelector('.post-title a');  
    const ex = post.querySelector('.post-excerpt');

    if (c) c.style.display = 'block';  
    if (a) a.style.display = 'none';  
    if (ex) ex.style.display = 'none';
  
    if (pushState) push(post.dataset.url);  
    debug();  
  }

  function render404(path, pushState) {  
    STATE = '404';  
    hideAll();  
    safe(page404, el => el.style.display = 'block');  
    if (pushState) push(path);  
    debug();  
  }

  /* ---------------- Path Finder ---------------- */

  function findPostByPath(path) {  
    const posts = getPosts();
    const target = path.replace(/\/$/, "").replace(".html", "");
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace(".html", "");
    
    // Cegah URL blog list dianggap sebagai post
    if (target === cleanBlogPath || target === "") return null;

    return posts.find(p => {
      const postUrl = p.dataset.url;
      if (!postUrl) return false;
      const cleanPostUrl = postUrl.replace(/\/$/, "").replace(".html", "");
      return cleanPostUrl.endsWith(target) || target.endsWith(cleanPostUrl);
    });
  }

  /* ---------------- Router ---------------- */  

  function router(path = location.pathname, pushState = false) {  
    const cleanPath = path.replace(/\/$/, "").replace("/index.html", "") || "/";
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "").replace("/index.html", "");

    safe(debugBox, box => box.innerHTML = `<b>[ROUTING]</b> Path: ${cleanPath}<br>`);

    if (cleanPath === '/' || cleanPath === '/index.html') {
      return renderHome(pushState);
    }

    // Prioritaskan cek List Mode dengan Exact Match
    if (cleanPath === cleanBlogPath || cleanPath === (cleanBlogPath + ".html") || path.includes('blog.html')) {
      // Tambahan proteksi: jika ini bukan file blog utama, biarkan lanjut ke pengecekan post
      if (cleanPath !== cleanBlogPath && findPostByPath(cleanPath)) {
         // Lanjut ke bawah
      } else {
         return renderList(pushState);
      }
    }

    const post = findPostByPath(cleanPath);  
    if (post) {
      return renderPost(post, pushState);
    }

    render404(path, pushState);  
  }

  /* ---------------- Event Listeners ---------------- */

  document.addEventListener('click', e => {
    const a = e.target.closest('a');
    if (!a) return;
    
    const href = a.getAttribute('href');
    if (!href || href.startsWith('#')) return;

    try {
      const url = new URL(href, location.origin);
      if (url.origin === location.origin) {
        e.preventDefault();
        router(url.pathname, true);
      }
    } catch (err) {}
  });

  if (btnBlog) {
    btnBlog.addEventListener('click', (e) => {
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', () => {  
    router(location.pathname, false);  
  });  

  /* ---------------- Debug Overlay (Restored) ---------------- */  
  
  function debug() {  
    if (!debugBox) return;  
    debugBox.innerHTML += `<hr><b>STATE:</b> ${STATE}<br><b>PATH:</b> ${location.pathname}`;  
  }  

  if (debugBox) {  
    debugBox.addEventListener('click', () => {  
      const htmlToCopy = debugBox.innerHTML;  
      navigator.clipboard.writeText(htmlToCopy).then(() => {  
        const msg = document.createElement('div');
        msg.innerHTML = `<i>Copied debug overlay! ðŸ“‹</i>`;
        debugBox.appendChild(msg);
      });  
    });  
  }  

  router(location.pathname, false);
});  
</script>
