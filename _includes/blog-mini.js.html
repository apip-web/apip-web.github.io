{% include homepage.html %}

<h1 id="tag-title">All Posts</h1>

<div id="posts">
  <div class="list-title"><h1>Blog:</h1></div>
  {% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}" data-tags="{{ post.tags | join: ',' }}">
    <h2 class="post-title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h2>
    <div class="post-tags">
      {% for tag in post.tags %}
      <button class="tag" data-tag="{{ tag }}">#{{ tag }}</button>
      {% endfor %}
    </div>
    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords:25 }}
      {% endif %}
    </div>
    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">{{ post.content | markdownify }}</div>
    </div>
  </article>
  {% endfor %}
</div>

<div id="pagination-container" class="pagination"></div>

<button id="show-all">All tags</button>

<div id="page-404">
  <h1>404</h1>
  <p>Halaman tidak ditemukan.</p>
  <a href="/">Kembali ke Home</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const homepage = document.querySelector('.homepage');
    const btnBlog = document.getElementById('open-blog');
    const postsWrap = document.getElementById('posts');
    const page404 = document.getElementById('page-404');
    const debugBox = document.getElementById('spa-debug');
    const listTitle = document.querySelector('.list-title');
    const spaHome = document.getElementById('spa-home');
    const BLOG_PATH = '/blog/';
    let STATE = '';
    let currentPage = 1;
    const itemsPerPage = 2; // Saya ubah ke 5 agar lebih proporsional

    const safe = (el, fn) => el && fn(el);
    const getPosts = () => [...document.querySelectorAll('.post')];

    /* CORE */
    function hideAll() {
        [spaHome, homepage, postsWrap, page404].forEach(el => safe(el, e => {
            e.style.display = 'none';
            e.classList.remove('animate-slide');
        }));

        safe(listTitle, el => el.style.display = 'none');
        safe(document.getElementById('tag-title'), el => el.style.display = 'none');
        safe(document.getElementById('show-all'), el => el.style.display = 'none');

        getPosts().forEach(p => {
            p.style.display = 'none';
            safe(p.querySelector('.post-content'), c => c.style.display = 'none');
            safe(p.querySelector('.post-title a'), a => a.style.display = '');
            safe(p.querySelector('.post-excerpt'), ex => ex.style.display = 'block');
        });

        const pContainer = document.getElementById('pagination-container');
        if (pContainer) pContainer.innerHTML = '';
    }

    function push(path) { if (location.pathname + location.search !== path) history.pushState(null, '', path); }

    /* RENDERERS */
function renderHome(pushState) {
    STATE = 'home';
    hideAll(); // Panggil pembersihan total

    [spaHome, homepage].forEach(el => safe(el, e => {
        e.style.display = 'block';
        e.classList.add('animate-slide');
    }));

    if (pushState) push('/');
    debug();
}

// Fungsi pembantu agar kode tidak berulang
function triggerPageAnimation() {
    safe(postsWrap, el => {
        el.classList.remove('animate-slide');
        void el.offsetWidth; // Force restart animasi
        el.classList.add('animate-slide');
    });
}

function renderList() {
    STATE = 'list';
    hideAll();
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => el.style.display = 'block');
    
    applyPagination();
    triggerPageAnimation(); // Animasikan seluruh container
    debug();
}

function renderTag(tag) {
    STATE = 'tag';
    hideAll(); // hideAll harus membersihkan display semua post

    safe(document.getElementById('tag-title'), el => {
        el.style.display = 'block';
        el.textContent = `Showing all posts under "${tag}"`;
    });
    safe(document.getElementById('show-all'), el => el.style.display = 'inline-block');
    safe(postsWrap, el => el.style.display = 'block');

    // JANGAN tulis currentPage = 1 di sini! 
    // Biarkan currentPage diatur oleh router dari URL (?page=2)

    applyPagination(); 
    triggerPageAnimation();
    debug();
}

function renderPost(post, pushState) {
    STATE = 'post';
    hideAll();

    safe(postsWrap, el => el.style.display = 'block');
    
    // Tampilkan detail post
    post.style.display = 'block';
    safe(post.querySelector('.post-content'), c => c.style.display = 'block');
    safe(post.querySelector('.post-title a'), a => a.style.display = 'none');
    safe(post.querySelector('.post-excerpt'), ex => ex.style.display = 'none');

    triggerPageAnimation(); // Animasikan seluruh container post detail
    
    if (pushState) push(post.dataset.url);
    debug();
}

    /* PAGINATION LOGIC */
function applyPagination() {
    const pContainer = document.getElementById('pagination-container');
    if (!pContainer) return;

    // Ambil tag dari URL saat ini
    const urlParams = new URLSearchParams(window.location.search);
    const currentTag = urlParams.get('tag');

    let activePosts = [];

    if (currentTag) {
        // Jika ada tag, saring post berdasarkan tag tersebut
        activePosts = getPosts().filter(p => {
            const tags = (p.dataset.tags || '').split(',');
            return tags.includes(currentTag);
        });
    } else {
        // Jika tidak ada tag, ambil semua post (halaman blog utama)
        activePosts = getPosts();
    }

    const totalPages = Math.ceil(activePosts.length / itemsPerPage);

    // Sembunyikan semua post dulu
    getPosts().forEach(p => p.style.display = 'none');

    // Tampilkan hanya yang masuk range halaman aktif dari hasil saringan (activePosts)
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    
    activePosts.slice(start, end).forEach(p => {
        p.style.display = 'block';
    });

    renderPaginationButtons(totalPages, pContainer);
}

function renderPaginationButtons(totalPages, container) {
    container.innerHTML = '';
    if (totalPages <= 1) return;

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `page-num ${i === currentPage ? 'active' : ''}`;
        
        btn.onclick = (e) => {
            e.preventDefault();
            const url = new URL(window.location.href);
            
            // Set halaman baru di URL
            url.searchParams.set('page', i);
            
            // Panggil router: Ini akan otomatis menjalankan renderTag atau renderList
            // tergantung apakah ada parameter ?tag di URL tersebut.
            router(url.pathname + url.search, true);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        container.appendChild(btn);
    }
}

    /* ROUTER */
function router(path, pushState) {
    LAST_ROUTE_PATH = path;
    if (pushState) history.pushState(null, '', path);

    const url = new URL(path, location.origin);
    const pathname = url.pathname.replace(/\/$/, '');
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, '');
    
    // ðŸ”¥ KUNCINYA DI SINI: Update currentPage setiap kali router jalan
    const pageParam = url.searchParams.get('page');
    currentPage = parseInt(pageParam) || 1; 

    const tag = url.searchParams.get('tag');

    if (pathname === '' || pathname === '/' || pathname === '/index.html') return renderHome();
    
    if (pathname === cleanBlogPath) {
        // Jika masuk ke /blog/ tanpa parameter, arahkan ke ?page=1
        if (!url.searchParams.has('page') && !tag) {
            const newPath = cleanBlogPath + '/?page=1';
            history.replaceState(null, '', newPath);
            return router(newPath, false);
        }
        
        if (tag) return renderTag(tag);
        return renderList();
    }

    const post = findPostByPath(pathname);
    if (post) return renderPost(post, false);

    render404(path);
}

    function findPostByPath(path) {
        const target = path.replace(/\/$/, '').replace('.html', '');
        return getPosts().find(p => {
            const postUrl = p.dataset.url;
            if (!postUrl) return false;
            const cleanPostUrl = postUrl.replace(/\/$/, '').replace('.html', '');
            return cleanPostUrl.endsWith(target) || target.endsWith(cleanPostUrl);
        });
    }

    function render404(path) {
        STATE = '404'; hideAll();
        safe(page404, el => el.style.display = 'block');
        debug();
    }

    /* EVENTS */
    document.addEventListener('click', e => {
        const a = e.target.closest('a');
        if (a && a.origin === location.origin && !a.getAttribute('href').startsWith('#')) {
            e.preventDefault();
            router(a.pathname + a.search, true);
        }
        const tagBtn = e.target.closest('.tag');
        if (tagBtn) {
            e.preventDefault();
            router(`/blog/?tag=${encodeURIComponent(tagBtn.dataset.tag)}`, true);
        }
    });

    safe(document.getElementById('show-all'), btn => btn.onclick = () => router('/blog/', true));
    safe(btnBlog, btn => btn.onclick = () => router(BLOG_PATH, true));
    window.onpopstate = () => router(location.pathname + location.search, false);

/* DEBUG & COPY */
function debug() {
    if (!debugBox) return;
    let stateClass = (STATE === '404') ? 'badge-error' : 'badge-state';
    
    // Gunakan '=' (replace) alih-alih '+=' (append) agar tidak bertumpuk
    debugBox.innerHTML = `
        <div class="log-entry">
            <span class="badge badge-route">Routing</span> Path: ${LAST_ROUTE_PATH}
        </div>
        <div class="log-entry">
            <span class="badge ${stateClass}">State</span> ${STATE}
        </div>
        <div class="log-entry">
            <span class="badge badge-success">URL</span> ${location.pathname + location.search}
        </div>
    `;
}

// Pasang listener copy (hanya perlu sekali di luar fungsi debug)
if (debugBox) {
    debugBox.addEventListener('click', () => {
        const logs = debugBox.querySelectorAll('.log-entry');
        let markdownText = '';

        logs.forEach(log => {
            const rawText = log.innerText.replace(/\s+/g, ' ').trim();
            const routingMatch = rawText.match(/Routing\s+(Path:\s+\S+)/i);
            const stateMatch = rawText.match(/State\s+(\S+)/i);
            const urlMatch = rawText.match(/URL\s+(\S+)/i);

            if (routingMatch) markdownText += `**ROUTING** \`${routingMatch[1]}\` \n`;
            if (stateMatch) markdownText += `**STATE** \`${stateMatch[1]}\` \n`;
            if (urlMatch) markdownText += `**URL** \`${urlMatch[1]}\` \n`;
        });

        if (markdownText.trim()) {
            navigator.clipboard.writeText(markdownText.trim()).then(() => {
                const msg = document.createElement('div');
                msg.style.cssText = "color:#10b981;font-size:10px;margin-top:5px;";
                msg.innerHTML = '<i>âœ“ Copied current state!</i>';
                debugBox.appendChild(msg);
                setTimeout(() => msg.remove(), 2000);
            });
        }
    });
}

    router(location.pathname + location.search, false);
});
</script>
