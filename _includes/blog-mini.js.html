<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content { display: none; }

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px); /* Mulai dari sedikit di atas */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Berakhir di posisi asli */
  }
}

/* Class untuk memicu animasi */
.animate-slide {
  animation: slideDown 2s ease-out forwards;
}

.post-content p {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}

#spa-button {

}

#spa-debug {
  display: none;
  position: fixed;
  bottom: 15px;
  left: 15px;
  right: 15px;
  max-height: 150px;
  overflow-y: auto;
  background: rgba(15, 23, 42, 0.6); /* Dark slate with transparency */
  backdrop-filter: blur(8px); /* Efek blur kaca */
  color: #e2e8f0;
  font-family: 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  z-index: 9999;
  scrollbar-width: thin;
}

#spa-debug code {
  font-size: 11px;
}

/* Log Label Styles */
.log-entry { margin-bottom: 4px; line-height: 1.4; }
.badge {
  padding: 2px 5px;
  border-radius: 3px;
  font-weight: bold;
  text-transform: uppercase;
  margin-right: 5px;
}
.badge-route { background: #3b82f6; color: white; }
.badge-state { background: #8b5cf6; color: white; }
.badge-success { background: #10b981; color: white; }
.badge-error { background: #ef4444; color: white; }
</style>

<div id="page-404" style="display:none;">
    <h1>404</h1>
    <p>Halaman tidak ditemukan.</p>
    <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
<div class="list-title"><h1>Blog:</h1></div>
{% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
{% endfor %}
</div>

<div id="spa-debug"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  
  const BLOG_PATH = '/blog/';
  const TAGS_PATH = '/tags/';
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];  

  /* ---------------- Core Functions ---------------- */

  function hideAll() {  
    const containers = [spaHome, homepage, postsWrap, page404];
    containers.forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
    }));

    getPosts().forEach(p => {  
      p.style.display = 'none';
      safe(p.querySelector('.post-content'), c => c.style.display = 'none'); 
      safe(p.querySelector('.post-title a'), a => a.style.display = ''); 
      safe(p.querySelector('.post-excerpt'), ex => ex.style.display = 'block');
    });  
  }

function push(path) {  
  // Ambil URL lengkap (pathname + hash) jika ada
  const fullPath = path + (location.hash || "");
  if (location.pathname + location.hash !== fullPath) {  
    history.pushState(null, '', fullPath);  
  }  
}

  /* ---------------- Renderers ---------------- */  
  
  function renderHome(pushState) {  
    STATE = 'home'; hideAll();
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block'; e.classList.add('animate-slide');
    }));
    if (pushState) push('/'); debug();  
  }

  function renderList(pushState) {  
    STATE = 'list'; hideAll();
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => { el.style.display = 'block'; el.classList.add('animate-slide'); });  
    getPosts().forEach(p => {
        // Jangan tampilkan file tags.md di dalam list blog biasa
        if(p.dataset.url !== TAGS_PATH) p.style.display = 'block';
    });
    if (pushState) push(BLOG_PATH); debug();  
  }

  function renderPost(post, pushState) {  
    STATE = 'post'; hideAll();
    safe(postsWrap, el => { el.style.display = 'block'; el.classList.add('animate-slide'); });
    post.style.display = 'block';
    safe(post.querySelector('.post-content'), c => c.style.display = 'block');  
    safe(post.querySelector('.post-title a'), a => a.style.display = 'none');  
    safe(post.querySelector('.post-excerpt'), ex => ex.style.display = 'none');
    if (pushState) push(post.dataset.url); debug();  
  }

  function render404(path, pushState) {  
    STATE = '404'; hideAll();
    safe(page404, el => el.style.display = 'block');  
    if (pushState) push(path); debug();  
  }

  /* ---------------- Router ---------------- */

  function router(path = location.pathname, pushState = false) {
    const cleanPath = path.length > 1 ? path.replace(/\/$/, "") : path;
    const cleanBlogPath = BLOG_PATH.replace(/\/$/, "");
    const cleanTagsPath = TAGS_PATH.replace(/\/$/, "");

    if (cleanPath === '' || cleanPath === '/' || cleanPath === '/index.html') return renderHome(pushState);
    if (cleanPath === cleanBlogPath) return renderList(pushState);

    // LOGIKA KHUSUS TAGS
// LOGIKA KHUSUS TAGS
    if (cleanPath === cleanTagsPath) {
      STATE = 'tags'; hideAll();
      safe(postsWrap, el => el.style.display = 'block');
      
      const allPosts = getPosts();
      const tagsController = allPosts.find(p => p.dataset.url === TAGS_PATH);

      if (tagsController) {
        tagsController.style.display = 'block';
        safe(tagsController.querySelector('.post-content'), c => c.style.display = 'block');
        
        allPosts.forEach(p => {
          if (p !== tagsController) {
            p.style.display = 'block';
            safe(p.querySelector('.post-content'), c => c.style.display = 'none');
          }
        });
      }

      // PERBAIKAN DI SINI: Sertakan hash saat push state
      if (pushState) {
          const pathWithHash = path + (location.hash || "");
          push(pathWithHash); 
      }
      
      debug();
      
      if (typeof window.handleTags === 'function') {
          // Beri jeda sedikit agar DOM siap sebelum filter
          setTimeout(window.handleTags, 50);
      }
      return;
    }

    const post = getPosts().find(p => p.dataset.url === path);
    if (post) return renderPost(post, pushState);

    render404(path, pushState);
  }

  /* ---------------- Event Listeners ---------------- */

  document.addEventListener('click', e => {
    const a = e.target.closest('a');
    if (!a) return;
    const href = a.getAttribute('href');
    if (!href) return;

    // Handle link dengan hash (untuk Tags)
    if (href.includes('#')) {
      const [path, hash] = href.split('#');
      const cleanH = path.replace(/\/$/, "");
      if (cleanH === '/tags' || path === TAGS_PATH) {
        e.preventDefault();
        router(TAGS_PATH, true);
        location.hash = hash;
        return;
      }
    }

    try {
      const url = new URL(href, location.origin);
      if (url.origin === location.origin) {
        e.preventDefault();
        router(url.pathname, true);
      }
    } catch (err) {}
  });

  if (btnBlog) {
    btnBlog.addEventListener('click', (e) => {
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', () => router(location.pathname, false));

  /* ---------------- Debug ---------------- */

function debug() {  
    if (!debugBox) return;  
    let stateClass = (STATE === '404') ? 'badge-error' : 'badge-state';
    // Menampilkan pathname dan hash di debug
    const currentFullURL = location.pathname + location.hash;
    
    debugBox.innerHTML += `
      <div class="log-entry" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px;">
        <span class="badge ${stateClass}">State</span> ${STATE} | <span class="badge badge-success">URL</span> ${currentFullURL}
      </div>`;
    debugBox.scrollTop = debugBox.scrollHeight;
  }

  if (debugBox) {
    debugBox.addEventListener('click', () => {
      navigator.clipboard.writeText(debugBox.innerText);
      const m = document.createElement('div'); m.innerHTML = '<i>âœ“ Copied!</i>'; m.style.color='#10b981'; m.style.fontSize='10px';
      debugBox.appendChild(m); setTimeout(() => m.remove(), 2000);
    });
  }

  router(location.pathname, false);
});
</script>
