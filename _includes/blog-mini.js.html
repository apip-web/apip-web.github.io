<style>
.pagination {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 30px 0;
}

.page-num {
  background: transparent;
  border: 1px solid var(--hr);
  color: var(--text-muted);
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 6px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.page-num.active {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(var(--accent-rgb), 0.1);
}

.page-num:hover:not(.active) {
  border-color: var(--text-main);
  color: var(--text-main);
}
</style>

{% include homepage.html %}

<h1 id="tag-title">All Posts</h1>

<div id="posts">
  <div class="list-title"><h1>Blog:</h1></div>
  {% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}" data-tags="{{ post.tags | join: ',' }}">
    <h2 class="post-title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h2>
    <div class="post-tags">
      {% for tag in post.tags %}
      <button class="tag" data-tag="{{ tag }}">#{{ tag }}</button>
      {% endfor %}
    </div>
    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords:25 }}
      {% endif %}
    </div>
    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">{{ post.content | markdownify }}</div>
    </div>
  </article>
  {% endfor %}
</div>

<div id="pagination-container" class="pagination"></div>

<button id="show-all">All tags</button>

<div id="page-404">
  <h1>404</h1>
  <p>Halaman tidak ditemukan.</p>
  <a href="/">Kembali ke Home</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const homepage = document.querySelector('.homepage');
    const btnBlog = document.getElementById('open-blog');
    const postsWrap = document.getElementById('posts');
    const page404 = document.getElementById('page-404');
    const debugBox = document.getElementById('spa-debug');
    const listTitle = document.querySelector('.list-title');
    const spaHome = document.getElementById('spa-home');
    const BLOG_PATH = '/blog/';
    let STATE = '';
    let currentPage = 1;
    const itemsPerPage = 5; // Saya ubah ke 5 agar lebih proporsional

    const safe = (el, fn) => el && fn(el);
    const getPosts = () => [...document.querySelectorAll('.post')];

    /* CORE */
    function hideAll() {
        [spaHome, homepage, postsWrap, page404].forEach(el => safe(el, e => {
            e.style.display = 'none';
            e.classList.remove('animate-slide');
        }));

        safe(listTitle, el => el.style.display = 'none');
        safe(document.getElementById('tag-title'), el => el.style.display = 'none');
        safe(document.getElementById('show-all'), el => el.style.display = 'none');

        getPosts().forEach(p => {
            p.style.display = 'none';
            safe(p.querySelector('.post-content'), c => c.style.display = 'none');
            safe(p.querySelector('.post-title a'), a => a.style.display = '');
            safe(p.querySelector('.post-excerpt'), ex => ex.style.display = 'block');
        });

        const pContainer = document.getElementById('pagination-container');
        if (pContainer) pContainer.innerHTML = '';
    }

    function push(path) { if (location.pathname + location.search !== path) history.pushState(null, '', path); }

    /* RENDERERS */
    function renderHome() {
        STATE = 'home';
        hideAll();
        [spaHome, homepage].forEach(el => safe(el, e => {
            e.style.display = 'block';
            e.classList.add('animate-slide');
        }));
        debug();
    }

    function renderList() {
        STATE = 'list';
        hideAll();
        safe(listTitle, el => el.style.display = 'block');
        safe(postsWrap, el => {
            el.style.display = 'block';
            el.classList.add('animate-slide');
        });
        applyPagination();
        debug();
    }

    function renderTag(tag) {
        STATE = 'tag';
        currentPage = 1;
        hideAll();
        const tagTitle = document.getElementById('tag-title');
        if (tagTitle) {
            tagTitle.style.display = 'block';
            tagTitle.textContent = `Showing all posts under "${tag}"`;
        }
        safe(postsWrap, el => {
            el.style.display = 'block';
            el.classList.add('animate-slide');
        });
        applyPagination();
        safe(document.getElementById('show-all'), el => el.style.display = 'inline-block');
        debug();
    }

    function renderPost(post, pushState) {
        STATE = 'post';
        hideAll();
        safe(postsWrap, el => {
            el.style.display = 'block';
            el.classList.add('animate-slide');
        });
        post.style.display = 'block';
        safe(post.querySelector('.post-content'), c => c.style.display = 'block');
        safe(post.querySelector('.post-title a'), a => a.style.display = 'none');
        safe(post.querySelector('.post-excerpt'), ex => ex.style.display = 'none');
        if (pushState) push(post.dataset.url);
        debug();
    }

    /* PAGINATION LOGIC */
    function applyPagination() {
        const pContainer = document.getElementById('pagination-container');
        if (!pContainer) return;

        let activePosts = [];
        if (STATE === 'tag') {
            const urlParams = new URLSearchParams(window.location.search);
            const tag = urlParams.get('tag');
            activePosts = getPosts().filter(p => (p.dataset.tags || '').split(',').includes(tag));
        } else {
            activePosts = getPosts();
        }

        const totalPages = Math.ceil(activePosts.length / itemsPerPage);
        
        // Reset ke hal 1 jika halaman yang diminta tidak ada (misal setelah filter)
        if (currentPage > totalPages) currentPage = 1;

        getPosts().forEach(p => p.style.display = 'none');

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        activePosts.slice(start, end).forEach(p => p.style.display = 'block');

        renderPaginationButtons(totalPages, pContainer);
    }

    function renderPaginationButtons(totalPages, container) {
        container.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `page-num ${i === currentPage ? 'active' : ''}`;
            btn.onclick = (e) => {
                e.preventDefault();
                currentPage = i;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                STATE === 'tag' ? applyPagination() : renderList();
            };
            container.appendChild(btn);
        }
    }

    /* ROUTER */
    let LAST_ROUTE_PATH = '';
    function router(path, pushState) {
        LAST_ROUTE_PATH = path;
        if (pushState) history.pushState(null, '', path);

        const url = new URL(path, location.origin);
        const pathname = url.pathname.replace(/\/$/, '');
        const cleanBlogPath = BLOG_PATH.replace(/\/$/, '');
        const tag = url.searchParams.get('tag');

        if (pathname === '' || pathname === '/' || pathname === '/index.html') return renderHome();
        if (pathname === cleanBlogPath) return tag ? renderTag(tag) : renderList();

        const post = findPostByPath(pathname);
        if (post) return renderPost(post, false);

        render404(path);
    }

    function findPostByPath(path) {
        const target = path.replace(/\/$/, '').replace('.html', '');
        return getPosts().find(p => {
            const postUrl = p.dataset.url;
            if (!postUrl) return false;
            const cleanPostUrl = postUrl.replace(/\/$/, '').replace('.html', '');
            return cleanPostUrl.endsWith(target) || target.endsWith(cleanPostUrl);
        });
    }

    function render404(path) {
        STATE = '404'; hideAll();
        safe(page404, el => el.style.display = 'block');
        debug();
    }

    /* EVENTS */
    document.addEventListener('click', e => {
        const a = e.target.closest('a');
        if (a && a.origin === location.origin && !a.getAttribute('href').startsWith('#')) {
            e.preventDefault();
            router(a.pathname + a.search, true);
        }
        const tagBtn = e.target.closest('.tag');
        if (tagBtn) {
            e.preventDefault();
            router(`/blog/?tag=${encodeURIComponent(tagBtn.dataset.tag)}`, true);
        }
    });

    safe(document.getElementById('show-all'), btn => btn.onclick = () => router('/blog/', true));
    safe(btnBlog, btn => btn.onclick = () => router(BLOG_PATH, true));
    window.onpopstate = () => router(location.pathname + location.search, false);

    function debug() {
        if (!debugBox) return;
        debugBox.innerHTML += `<div class="log-entry"><span class="badge">State</span> ${STATE} | ${location.pathname}</div>`;
        debugBox.scrollTop = debugBox.scrollHeight;
    }

    router(location.pathname + location.search, false);
});
</script>
