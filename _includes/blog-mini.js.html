<style>
#spa-home,
#posts,
.homepage,
#page-404,
.post-content { display: none; }

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px); /* Mulai dari sedikit di atas */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* Berakhir di posisi asli */
  }
}

/* Class untuk memicu animasi */
.animate-slide {
  animation: slideDown 2s ease-out forwards;
}

.post-content p {
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}

#spa-button {

}

#spa-debug {
  display: none;
  position: fixed;
  bottom: 15px;
  left: 15px;
  right: 15px;
  max-height: 150px;
  overflow-y: auto;
  background: rgba(15, 23, 42, 0.6); /* Dark slate with transparency */
  backdrop-filter: blur(8px); /* Efek blur kaca */
  color: #e2e8f0;
  font-family: 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  z-index: 9999;
  scrollbar-width: thin;
}

#spa-debug code {
  font-size: 11px;
}

/* Log Label Styles */
.log-entry { margin-bottom: 4px; line-height: 1.4; }
.badge {
  padding: 2px 5px;
  border-radius: 3px;
  font-weight: bold;
  text-transform: uppercase;
  margin-right: 5px;
}
.badge-route { background: #3b82f6; color: white; }
.badge-state { background: #8b5cf6; color: white; }
.badge-success { background: #10b981; color: white; }
.badge-error { background: #ef4444; color: white; }
</style>

<div id="page-404" style="display:none;">
    <h1>404</h1>
    <p>Halaman tidak ditemukan.</p>
    <a href="/">Kembali ke Home</a>
</div>

<div id="posts">
<div class="list-title"><h1>Blog:</h1></div>
{% for post in site.posts %}
  <article class="post" data-url="{{ post.url | relative_url }}">
    <h2 class="post-title">
      <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
    </h2>

    <div class="post-excerpt">
      {% if post.description %}
        {{ post.description }}
      {% else %}
        {{ post.excerpt | strip_html | truncatewords: 25 }}
      {% endif %}
    </div>

    <div class="post-content">
      {% include post-meta.html post=post %}
      <div class="entry-content">
        {{ post.content | markdownify }}
      </div>
    </div>
  </article>
{% endfor %}
</div>

<div id="spa-debug"></div>

<script>  
document.addEventListener('DOMContentLoaded', () => {
  const homepage  = document.querySelector('.homepage');
  const btnBlog   = document.getElementById('open-blog');
  const postsWrap = document.getElementById('posts');
  const page404   = document.getElementById('page-404');
  const debugBox  = document.getElementById('spa-debug');
  const listTitle = document.querySelector('.list-title');
  const spaHome   = document.getElementById('spa-home');
  
  const BLOG_PATH = '/blog/';
  const TAGS_PATH = '/tags/';
  let STATE       = '';

  const safe = (el, fn) => el && fn(el);
  const getPosts = () => [...document.querySelectorAll('.post')];  

  /* ---------------- Core Functions ---------------- */

  function hideAll() {  
    const containers = [spaHome, homepage, postsWrap, page404];
    containers.forEach(el => safe(el, e => {
      e.style.display = 'none';
      e.classList.remove('animate-slide');
      void e.offsetWidth; 
    }));

    getPosts().forEach(p => {  
      p.style.display = 'none';
      const c = p.querySelector('.post-content');  
      const a = p.querySelector('.post-title a');  
      const ex = p.querySelector('.post-excerpt');
      if (c) c.style.display = 'none'; 
      if (a) a.style.display = ''; 
      if (ex) ex.style.display = 'block';
    });  
  }

  function push(path) {  
    if (location.pathname !== path) {  
      history.pushState(null, '', path);  
    }  
  }  
  
  /* ---------------- Renderers ---------------- */  
  
  function renderHome(pushState) {  
    STATE = 'home';  
    hideAll(); 
    [spaHome, homepage].forEach(el => safe(el, e => {
      e.style.display = 'block';
      e.classList.add('animate-slide');
    })); 
    if (pushState) push('/');  
    debug();  
  }

  function renderList(pushState) {  
    STATE = 'list';  
    hideAll(); 
    safe(listTitle, el => el.style.display = 'block');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });  
    getPosts().forEach(p => p.style.display = 'block');
    if (pushState) push(BLOG_PATH);  
    debug();  
  }

  function renderPost(post, pushState) {  
    STATE = 'post';  
    hideAll();
    safe(listTitle, el => el.style.display = 'none');
    safe(postsWrap, el => {
        el.style.display = 'block';
        el.classList.add('animate-slide');
    });
    
    post.style.display = 'block';
    const c = post.querySelector('.post-content');  
    const a = post.querySelector('.post-title a');  
    const ex = post.querySelector('.post-excerpt');

    if (c) c.style.display = 'block';  
    if (a) a.style.display = 'none';  
    if (ex) ex.style.display = 'none';
  
    if (pushState) push(post.dataset.url);  
    debug();  
  }

  function render404(path, pushState) {  
    STATE = '404';  
    hideAll();  
    safe(page404, el => el.style.display = 'block');  
    if (pushState) push(path);  
    debug();  
  }

/* --- Finder yang lebih sederhana dan aman --- */
function findPostByPath(path) {
  const posts = getPosts();
  // Bandingkan path apa adanya dari browser dengan data-url di HTML
  return posts.find(p => p.dataset.url === path);
}

/* --- Router yang lebih stabil --- */
function router(path = location.pathname, pushState = false) {

  const cleanPath = path.length > 1 ? path.replace(/\/$/, "") : path;

  const cleanBlogPath = BLOG_PATH.replace(/\/$/, "");

  const cleanTagsPath = TAGS_PATH.replace(/\/$/, "");



  // 1. Cek Home & Blog List (Kode lama Anda...)

  if (cleanPath === '' || cleanPath === '/' || cleanPath === '/index.html') return renderHome(pushState);

  if (cleanPath === cleanBlogPath) return renderList(pushState);



  // 2. TAMBAHKAN INI: Pengecekan khusus halaman Tags

  if (cleanPath === cleanTagsPath) {
    STATE = 'tags';
    hideAll(); 

    // 1. Tampilkan kontainer utama
    safe(postsWrap, el => {
      el.style.display = 'block';
      el.classList.add('animate-slide');
    });

    // 2. CARI dan TAMPILKAN konten unik milik halaman Tags
    // Kita mencari artikel yang data-url-nya adalah /tags/
    const tagsPage = getPosts().find(p => p.dataset.url === TAGS_PATH || p.dataset.url === '/tags/');
    
    if (tagsPage) {
      tagsPage.style.display = 'block';
      // Tampilkan konten dalamnya (judul All Posts, tombol filter, dll)
      safe(tagsPage.querySelector('.post-content'), c => c.style.display = 'block');
      // Sembunyikan excerpt jika ada
      safe(tagsPage.querySelector('.post-excerpt'), ex => ex.style.display = 'none');
    }

    // 3. Tampilkan semua postingan blog di bawahnya untuk difilter
    getPosts().forEach(p => {
      if (p !== tagsPage) { // Jangan sembunyikan halaman tags itu sendiri
        p.style.display = 'block';
      }
    });

    if (pushState) push(path);
    debug();
    
    // Jalankan filter hash jika ada
    if (typeof handleTags === 'function') handleTags();
    return;
  }

  // 3. Cek Postingan (Kode lama Anda...)

  const post = findPostByPath(path);

  if (post) return renderPost(post, pushState);



  render404(path, pushState);

}

  /* ---------------- Event Listeners ---------------- */

document.addEventListener('click', e => {

  const a = e.target.closest('a');

  if (!a) return;

  const href = a.getAttribute('href');

  if (!href) return;



  // Jika klik link yang mengandung hash (#)

  if (href.includes('#')) {

    const [urlPath, hash] = href.split('#');

    const cleanUrlPath = urlPath.replace(/\/$/, "") || "/";

    const currentPath = location.pathname.replace(/\/$/, "") || "/";



    // Jika kita sudah di halaman yang sama (misal di /tags/), cukup biarkan browser update hash

    if (cleanUrlPath === currentPath || href.startsWith('#')) {

      return; 

    }

    

    // Jika dari halaman lain (misal home) mau ke /tags/#tag

    e.preventDefault();

    router(urlPath, true); // Pindah halaman dulu secara SPA

    location.hash = hash;  // Baru set hash-nya

    return;

  }



  // Logika navigasi SPA biasa...

  try {

    const url = new URL(href, location.origin);

    if (url.origin === location.origin) {

      e.preventDefault();

      router(url.pathname, true);

    }

  } catch (err) {}

});

  if (btnBlog) {
    btnBlog.addEventListener('click', (e) => {
      e.preventDefault();
      router(BLOG_PATH, true);
    });
  }

  window.addEventListener('popstate', () => {  
    router(location.pathname, false);  
  });  

/* ---------------- Debug Overlay Logic ---------------- */

  function debug() {  
    if (!debugBox) return;  
    
    let stateClass = (STATE === '404') ? 'badge-error' : 'badge-state';
    
    debugBox.innerHTML += `
      <div class="log-entry" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px;">
        <span class="badge ${stateClass}">State</span> ${STATE}
      </div>
      <div class="log-entry">
        <span class="badge badge-success">URL</span> ${location.pathname}
      </div>`;
    
    debugBox.scrollTop = debugBox.scrollHeight;
  }

  // FITUR COPY: Menggunakan penanganan error agar lebih stabil
  if (debugBox) {  
    debugBox.addEventListener('click', function() {  
      // Ambil teks bersih (tanpa tag HTML) agar hasil paste rapi
      const contentToCopy = debugBox.innerText; 
      
      navigator.clipboard.writeText(contentToCopy).then(() => {  
        const msg = document.createElement('div');
        msg.style.color = '#10b981';
        msg.style.fontSize = '10px';
        msg.style.marginTop = '5px';
        msg.innerHTML = `<i>âœ“ Copied to clipboard!</i>`;
        debugBox.appendChild(msg);
        debugBox.scrollTop = debugBox.scrollHeight;
        
        // Hapus pesan notifikasi setelah 2 detik
        setTimeout(() => msg.remove(), 2000);
      }).catch(err => {
        console.error('Gagal menyalin: ', err);
      });  
    });  
  }

  // INISIALISASI: Jalankan router pertama kali saat halaman dimuat
  router(location.pathname, false);

}); // Tutup DOMContentLoaded
</script>
